prometheus.remote_write "default" {
	external_labels = {}

	endpoint {
		name = "remote1"
		url  = "http://remote-write-url1"

		queue_config {
			capacity             = 2500
			max_shards           = 200
			max_samples_per_send = 500
		}

		metadata_config {
			max_samples_per_send = 500
		}
	}
}

discovery.relabel "prometheus1" {
	targets = []

	rule {
		source_labels = ["__address1__"]
		regex         = "^(?:(.*))$"
		target_label  = "__param_target1"
	}

	rule {
		source_labels = ["__address__"]
		regex         = "^(?:(\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}):\\\\d+)$"
		target_label  = "instance"
		replacement   = "${1}"
	}
}

prometheus.scrape "prometheus1" {
	targets = concat([{
		__address__ = "localhost:9090",
	}],
		discovery.relabel.prometheus1.targets)
	forward_to = [prometheus.remote_write.default.receiver]
	job_name   = "prometheus1"
}

discovery.azure "prometheus2" {
	subscription_id = "subscription"

	managed_identity {
		client_id = "client"
	}
	follow_redirects = true
	enable_http2     = true
}

discovery.relabel "prometheus2" {
	targets = discovery.azure.prometheus2.targets

	rule {
		source_labels = ["__address1__"]
		regex         = "^(?:(.*))$"
		target_label  = "__param_target1"
	}

	rule {
		source_labels = ["__address2__"]
		regex         = "^(?:(.*))$"
		target_label  = "__param_target2"
	}
}

prometheus.scrape "prometheus2" {
	targets = concat([{
		__address__ = "localhost:9091",
	}],
		discovery.relabel.prometheus2.targets)
	forward_to = [prometheus.remote_write.default.receiver]
	job_name   = "prometheus2"
}
