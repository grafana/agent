---
# Source: grafana-agent/templates/controllers/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: grafana-agent
  labels:
    helm.sh/chart: grafana-agent-0.9.0
    app.kubernetes.io/name: grafana-agent
    app.kubernetes.io/instance: grafana-agent
    app.kubernetes.io/version: "v0.32.1"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  minReadySeconds: 10
  serviceName: grafana-agent
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana-agent
      app.kubernetes.io/instance: grafana-agent
  template:
    metadata:
      labels:
        app.kubernetes.io/name: grafana-agent
        app.kubernetes.io/instance: grafana-agent
    spec:
      serviceAccount: grafana-agent
      containers:
          - name: grafana-agent
            image: grafana/agent:v0.32.1
            imagePullPolicy: IfNotPresent
            args:
              - run
              - /etc/agent/config.river
              - --storage.path=/tmp/agent
              - --server.http.listen-addr=0.0.0.0:80
            env:
              - name: AGENT_MODE
                value: flow
              - name: HOSTNAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
            ports:
              - containerPort: 80
                name: http-metrics
              - containerPort: 12347
                name: faro
            readinessProbe:
              httpGet:
                path: /-/ready
                port: 80
              initialDelaySeconds: 10
              timeoutSeconds: 1
            volumeMounts:
              - name: config
                mountPath: /etc/agent
          - name: config-reloader
            image: jimmidyson/configmap-reload:v0.8.0
            args:
              - --volume-dir=/etc/agent
              - --webhook-url=http://localhost:80/-/reload
            volumeMounts:
              - name: config
                mountPath: /etc/agent
      volumes:
        - name: config
          configMap:
            name: grafana-agent
